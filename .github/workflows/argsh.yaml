name: argsh
on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    paths:
      - '.bin/**'
      - '.docker/**'
      - 'libraries/**'
      - 'test/**'
      - 'builtin/**'
      - 'minifier/**'
      - 'shdoc/**'
      - '.envrc'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

defaults:
  run:
    shell: bash -euo pipefail {0}

permissions: read-all

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Direnv
        uses: HatsuneMiku3939/direnv-action@v1
      - name: Lint
        run: argsh lint
      - name: Test
        run: argsh test
      - name: Extract artifacts from Docker
        run: |
          mkdir -p builtin/target/release minifier/target/release shdoc/target/release
          docker run --rm --entrypoint cat ghcr.io/arg-sh/argsh:latest /usr/local/lib/argsh.so > builtin/target/release/libargsh.so
          docker run --rm --entrypoint cat ghcr.io/arg-sh/argsh:latest /usr/local/bin/minifier > minifier/target/release/minifier
          docker run --rm --entrypoint cat ghcr.io/arg-sh/argsh:latest /usr/local/bin/shdoc > shdoc/target/release/shdoc
          chmod +x minifier/target/release/minifier shdoc/target/release/shdoc
      - name: Upload builtin library
        uses: actions/upload-artifact@v4
        with:
          name: argsh-builtin-so
          if-no-files-found: error
          retention-days: 7
          path: builtin/target/release/libargsh.so
      - name: Upload minifier binary
        uses: actions/upload-artifact@v4
        with:
          name: minifier-bin
          if-no-files-found: error
          retention-days: 7
          path: minifier/target/release/minifier
      - name: Upload shdoc binary
        uses: actions/upload-artifact@v4
        with:
          name: shdoc-bin
          if-no-files-found: error
          retention-days: 7
          path: shdoc/target/release/shdoc

  coverage:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Direnv
        uses: HatsuneMiku3939/direnv-action@v1
      - name: Coverage
        run: argsh coverage builtin
      - name: Is insync
        run: |
          git diff --exit-code \
            --ignore-matching-lines '^  "date":' \
            -- builtin/coverage.json

  minifier-coverage:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Direnv
        uses: HatsuneMiku3939/direnv-action@v1
      - name: Coverage
        run: argsh coverage minifier
      - name: Is insync
        run: |
          git diff --exit-code \
            --ignore-matching-lines '^  "date":' \
            -- minifier/coverage.json

  shdoc-coverage:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Direnv
        uses: HatsuneMiku3939/direnv-action@v1
      - name: Coverage
        run: argsh coverage shdoc
      - name: Is insync
        run: |
          git diff --exit-code \
            --ignore-matching-lines '^  "date":' \
            -- shdoc/coverage.json

  minify:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Download minifier binary
        uses: actions/download-artifact@v4
        with:
          name: minifier-bin
          path: .bin
      - name: Make minifier executable
        run: chmod +x .bin/minifier
      - name: Direnv
        uses: HatsuneMiku3939/direnv-action@v1
      - name: Build
        run: |
          argsh minify
      - name: Lint
        run: |
          argsh lint -m
      - name: Test
        run: |
          argsh test -m
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: argsh
          if-no-files-found: error
          retention-days: 7
          path: |
            argsh.min.sh

  build-binaries:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build ${{ matrix.arch }} binaries
        run: |
          docker buildx build --platform linux/${{ matrix.arch }} \
            --target artifacts \
            --output type=local,dest=out .
          chmod +x out/minifier out/shdoc
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-${{ matrix.arch }}
          if-no-files-found: error
          retention-days: 7
          path: out/

  minify-so:
    runs-on: ubuntu-latest
    needs: [minify, build-binaries]
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Download builtin library
        uses: actions/download-artifact@v4
        with:
          name: binaries-linux-${{ matrix.arch }}
          path: binaries
      - name: Download argsh artifact
        uses: actions/download-artifact@v4
        with:
          name: argsh
          path: .
      - name: Compose argsh-so
        run: |
          # Build script portion with appended-binary loader
          {
            head -3 argsh.min.sh
            echo '# ── Appended native builtins ─────────────────────────────────────────'
            echo 'ARGSH_PAYLOAD_OFFSET=PLACEHOLDER'
            cat << 'SOEOF'
          # obfus ignore function
          __argsh_load_appended_so() {
            local _t; _t="$(mktemp "${TMPDIR:-/tmp}/argsh.XXXXXX.so")"
            # shellcheck disable=SC2064
            trap "rm -f '${_t}'" EXIT
            tail -c +$((ARGSH_PAYLOAD_OFFSET)) "${BASH_SOURCE[0]}" > "${_t}" || return 1
            # shellcheck disable=SC2229
            enable -f "${_t}" \
              :usage :usage::help :usage::completion :usage::docgen :usage::mcp :args \
              is::array is::uninitialized is::set is::tty \
              args::field_name to::int to::float to::boolean to::file to::string \
              import import::clear \
              2>/dev/null || return 1
            rm -f "${_t}"
            return 0
          }
          # obfus ignore variable
          declare -gi ARGSH_BUILTIN=0
          if __argsh_load_appended_so; then
            ARGSH_BUILTIN=1
          fi
          unset -f __argsh_load_appended_so
          SOEOF
            echo '# ────────────────────────────────────────────────────────────────────'
            tail -n +4 argsh.min.sh
            cat << 'EXITEOF'

          if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
            exit ${?}
          else
            echo "argsh-so: cannot be sourced, use as shebang or execute directly" >&2
            return 1
          fi
          EXITEOF
          } > script-part.sh

          # Stabilize byte offset (loop until size converges)
          prev_sz=0
          for i in $(seq 1 10); do
            sz=$(wc -c < script-part.sh)
            [ "${sz}" -ne "${prev_sz}" ] || break
            prev_sz=${sz}
            sed -i "s/ARGSH_PAYLOAD_OFFSET=[0-9A-Z]*/ARGSH_PAYLOAD_OFFSET=$((sz + 1))/" script-part.sh
          done
          [ "${i}" -lt 10 ] || { echo "Failed to stabilize ARGSH_PAYLOAD_OFFSET" >&2; exit 1; }

          # Concatenate script + raw .so binary
          cat script-part.sh binaries/libargsh.so > argsh-so
          chmod +x argsh-so
          rm script-part.sh
      - name: Smoke test
        if: matrix.arch == 'amd64'
        run: |
          bash argsh-so --version
          bash -c '
            offset=$(head -20 argsh-so | grep -oP "ARGSH_PAYLOAD_OFFSET=\K[0-9]+")
            _t=$(mktemp /tmp/argsh-test.XXXXXX.so)
            tail -c +$((offset)) argsh-so > "${_t}"
            enable -f "${_t}" :args 2>/dev/null
            type :args | grep -q "shell builtin" || { echo "Builtin :args not loaded"; rm -f "${_t}"; exit 1; }
            echo "argsh-so: builtins loaded successfully"
            rm -f "${_t}"
          '
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: argsh-so-linux-${{ matrix.arch }}
          if-no-files-found: error
          retention-days: 7
          path: |
            argsh-so

  docker:
    runs-on: ubuntu-latest
    needs: [minify]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Download executables
        uses: actions/download-artifact@v4
        with:
          pattern: argsh
          merge-multiple: true
          path: .
      - name: Executable
        run: |
          chmod +x argsh.min.sh
      - name: Docker metadata
        uses: docker/metadata-action@v5
        id: metadata
        with:
          images: ghcr.io/${{ github.repository }}
          tags: ${{ startsWith(github.ref, 'refs/tags/v')
            && format('type=match,pattern=v(.*),group=1,value={0}', github.ref_name)
            || 'type=sha,format=long' }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and release Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ startsWith(github.ref, 'refs/tags/v') }}
          provenance: false
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    environment: release
    needs: [minify, minify-so, build-binaries, docker]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      - name: Download argsh script
        uses: actions/download-artifact@v4
        with:
          name: argsh
          path: artifacts
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binaries-linux-*
          path: artifacts
      - name: Download all argsh-so
        uses: actions/download-artifact@v4
        with:
          pattern: argsh-so-linux-*
          path: artifacts
      - name: Assemble release assets
        run: |
          mkdir -p release

          # argsh (arch-independent shell script)
          cp artifacts/argsh.min.sh release/argsh
          chmod +x release/argsh

          # Per-architecture assets
          for arch in amd64 arm64; do
            cp "artifacts/binaries-linux-${arch}/libargsh.so" "release/argsh-linux-${arch}.so"
            cp "artifacts/binaries-linux-${arch}/minifier"    "release/minifier-linux-${arch}"
            cp "artifacts/binaries-linux-${arch}/shdoc"       "release/shdoc-linux-${arch}"
            cp "artifacts/argsh-so-linux-${arch}/argsh-so" "release/argsh-so-linux-${arch}"
            chmod +x "release/minifier-linux-${arch}" "release/shdoc-linux-${arch}" "release/argsh-so-linux-${arch}"
          done

          cd release
          sha256sum * > sha256sum.txt
      - name: Upload release
        env:
          TAG_NAME: ${{ github.ref_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${TAG_NAME}" --draft --title "argsh ${TAG_NAME}" --generate-notes
          gh release upload "${TAG_NAME}" --clobber release/*

          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          title="Release ${TAG_NAME}"
          branch="release-${TAG_NAME}"

          cp artifacts/argsh.min.sh argsh.min.sh
          git add argsh.min.sh
          git commit -m "${title}"
          git push origin "HEAD:refs/heads/${branch}"
          gh pr create --title "${title}" --body "" --head "${branch}"
